<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Boksamling 42</title>
    <style>
    .loader{
        width: 100%;
        text-align: center;
        display: inline-block;
        vertical-align: top;
        display: none;
        position: absolute;
        z-index: 42;
    }
    #books{
        margin-top: 3em;
        height: 350px;
    }
    .emneord{
        margin: 1em;
    }
    #touchHand {
        margin-top: 2em;
    }
    </style>
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.css">
    <link rel="stylesheet" href="carouseal.css">
    <link rel="stylesheet" href="backbone.modal.css">
    <link rel="stylesheet" href="backbone.modal.theme.css">
    <meta name="viewport" content="width=device-width, initial-scale=0.35, maximum-scale=0.35, user-scalable=no">
    <style>
    	/* Sticky footer CSS */
        html {
          position: relative;
          min-height: 100%;
        }
        body {
          /* Margin bottom by footer height */
          margin-bottom: 150px;
        }
        .footer {
          position: absolute;
          bottom: 0;
          width: 100%;
          /* Set the fixed height of the footer here */
          height: 100px;
          /*background-color: #f5f5f5;*/
        }

        span.glyphicon {
            font-size: 8em;
        }
    </style>
</head>
<body>

<div class="container">
	<h1 class="text-center" id="pageTitle">Boksamling 42</h1>
	<hr>
</div>

<div class="container-fluid">

    <div class="loader" title="0">
        <svg version="1.1" id="loader-1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
        width="100px" height="100px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">
        <path opacity="0.2" fill="#000" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946
        s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634
        c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z"/>
        <path fill="#000" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0
        C22.32,8.481,24.301,9.057,26.013,10.047z">
            <animateTransform
                attributeType="xml"
                attributeName="transform"
                type="rotate"
                from="0 20 20"
                to="360 20 20"
                dur="0.5s"
                repeatCount="indefinite"/>
        </path>
        </svg>
    </div>

	<div id="books"></div>

    <div id="help"></div>

</div>

<div class="container">
    <div id="bookFull"></div>
</div>

<footer class="footer">
	<div class="container">
		<div class="row">
			<div class="col-sm-3">
				<p class="text-center">				
					<span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span>
				</p>
			</div>
			<div class="col-sm-6">
                <p class="text-center">             
                    <span class="glyphicon glyphicon-hand-up" aria-hidden="true"></span><br>
                </p>      
            </div>
			<div class="col-sm-3">
				<p class="text-center">
					<span id="helpIcon" class="glyphicon glyphicon-question-sign" aria-hidden="true"></span>			
				</p>
			</div>
		</div>
	</div>
</footer>

<script src="bower_components/jquery/dist/jquery.js"></script>
<script src="bower_components/underscore/underscore.js"></script>
<script src="bower_components/backbone/backbone.js"></script>
<script src="bower_components/hammerjs/hammer.js"></script>
<script src="carouseal.js"></script>
<script src="backbone.modal.js"></script>

<script id="bookListTemplate" type="text/template">
	<img src="<%= cover %>" data-url="<%= id %>" id="b<%= id %>" alt="">
</script>

<script id="bookFullTemplate" type="text/template">
    <hr>
    <div class="container">
        <a href="http://colligator.biblionaut.net/api/documents/<%= id %>" style="color:#ddd; font-size:80%; float:right;"><%= id %></a><!-- for debugging -->
        <h1><%= mainTitle %></h1>
        <% if(typeof(subTitle) !== "undefined") { %>
        	<h4><%= subTitle.capitalizeFirstLetter() %></h4>
        <% } %>
        <p>
        	<small>
        		Av: <%= authors %>
        		<br><%= publisher %>, <%= year %>
		        <% if (typeof(part_name) !== "undefined") { %>
					<br><%= part_no %> av <%= part_name %>.
		        <% } %>
        	</small>
        </p>
        <% if (available) { %>
            <div class="alert alert-success"><%= availableText %></div>
        <% } else { %>
            <div class="alert alert-danger"><%= availableText %></div>
        <% } %>
        <% if (typeof(description)!=="undefined") { %>
        	<p><%= description.text %></p>
        <% } %>
        <p class="text-center">
            <% _.each(subjects.noubomn, function(noubomnSubject) { %>
                <button type="button" class="emneord btn btn-lg btn-info"><%= noubomnSubject.prefLabel %></button>
            <% }); %>
        </p>
    </div>
</script>

<script type="text/template" id="helpModal">
    <div class="bbm-modal__topbar">
      <h3 class="bbm-modal__title">Hjelp</h3>
    </div>
    <div class="bbm-modal__section">
      <p>Her kan du se igjennom bøkene som finnes i vår 42-samling.</p>
      <p>Noen tips:</p>
      <ul>
        <li>Swipe til høyre eller venstre for å komme til en ny bok.</li>
        <li>Klikk på emneordene under den aktive boka for å gå til en ny kategori.</li>
      </ul>
    </div>
    <div class="bbm-modal__bottombar">
      <a href="#" class="bbm-button">lukk</a>
    </div>
  </script>

<script type="text/javascript">

"use strict";

// Extending String so that we can easily capitalize the first letter
String.prototype.capitalizeFirstLetter = function() {
    return this.charAt(0).toUpperCase() + this.slice(1);
};

(function() {

// ---------------------------------------- DEFINE MODEL + COLLECTION

var Book = Backbone.Model.extend({
    defaults: {
        title: '',
        isbn: '',
        authors: '',
        publisher: '',
        cover: 'http://snyderstreasures.com/images/thumbnails/germanmilitaria/books/BookReichsblattPlainC_small.jpg'
    }
});

var Books = Backbone.Collection.extend({
    model: Book,
    url: 'http://colligator.biblionaut.net/api/documents',
    parse: function(response, options) {

        // Remove (reject) books that has no holdings
        var data = _.reject(response.documents, function(element) {
            return element.holdings.length === 0;
        });

        // In the Book model above we've set a default image for the cover. The API gives cover: null if it didn't find a cover. Backbone will replace our own placeholder if the API returns any value at all (including null) for the cover property. Hence, we delete the cover property if the value is null, so that our placeholder cover is kept.
        // Also remove description if it's null
        // Also remove books with holdings===0
        data = _.map(data, function(val, ind, all) {
            if (val.cover===null) {
                delete val.cover;
            } else {
            	val.cover = val.cover.thumb.url;
            }

            if (val.description===null) {
            	delete val.description;
            }
            return val;
        });

        return data;
    }
});

// ---------------------------------------- DEFINE VIEWS

var BookView = Backbone.View.extend({
    tagName: 'li',
    className: 'book',
    render: function() {

        var template; // Will hold the compiled template
        var html; // Will hold the result of template(data)

        // Create template function
        template = _.template($('#bookListTemplate').html());
        // Give data to template function and produce html
        html = template(this.model.toJSON());
        // Insert produced html into the view element
        this.$el.append(html);

        return this;
    }
});

var BooksView = Backbone.View.extend({
    el: '#books',
    className: 'books',
    render: function() {

        // Remove old views
        this.removeOldViews();
        // Empty content in case carouseal left something
        this.$el.empty();

        // Create new views
        var self = this;
        this.model.each(function(book) {
            var bookView = new BookView({ model: book });
            self._views.push(bookView);
            self.$el.append(bookView.render().$el);
        });

        // Now that we have the images in the div, convert them to a carousel
        carouSeal.element = $("#books");
        carouSeal.initCarousel();

        return this;
    },
    initialize: function(options) {
        // Store reference to subviews created in render(), as we need to remove them when rerendering
        this._views = [];

    },
    removeOldViews: function() {
        _.each(this._views, function(view) {
            view.remove();
            view.unbind();
        });
    }
});

var BookFullView = Backbone.View.extend({
    el: '#bookFull',
    render: function() {

        var template; // Will hold the compiled template
        var html; // Will hold the result of template(data)

        // Only show information about a book if we have one
        if (this.model) {
            // Create a print-friendly attribute for the author names
            var authors = '';
            _.each(this.model.get('creators'), function(creator) {
                authors = authors.concat(', '+creator.name);
            });
            authors = authors.concat('.');
            authors = authors.substr(2); // Remove starting ', '
            // Store in model
            this.model.set('authors', authors);

            // The titles sometimes comes in as "Main title : subtitle : third title". We want that to display as mainTitle:"Main title" and the rest as restTitle:"subtitle : third title". In other words: Keep everything before the first " : " as the main title, and add the rest up as the subtitle if there is anything else.
            var titles = this.model.get('title').split(' : ');
            this.model.set('mainTitle', titles[0]);
            if (titles.length > 1) {
            	this.model.set('subTitle', titles.splice(1).join(' : '));
            }

            // Decide what the availability-text will be. Four possible cases:
            // 1. Book is in 42-collection and available.
            // 2. Book is at UREAL and available.
            // 3. Book is at UBO and available.
            // 4. Book is not available.
            var availableText = '';
            var available = true;
            // Check for case 1
            var available42 = _.findWhere(this.model.get('holdings'), {
                shelvinglocation: 'UREAL Samling 42',
                circulation_status: 'Available'
            });
            // Check for case 2
            var availableUREAL = _.findWhere(this.model.get('holdings'), {
                sublocation: 'UREAL',
                circulation_status: 'Available'
            });
            // Check for case 3
            var availableUBO = _.findWhere(this.model.get('holdings'), {
                location: 'UBO',
                circulation_status: 'Available'
            });
            if (available42) {
                availableText = 'Boken er tilgjengelig i 42-samlingen. Hylleplassering: ' + available42.callcode;
            } else if (availableUREAL) {
                availableText = 'Boken er tilgjengelig hos Realfagsbiblioteket. Hylleplassering: ' + availableUREAL.callcode;
            } else if (availableUBO) {
                availableText = 'Boken er tilgjengelig hos Universitetsbiblioteket. Hylleplassering: ' + availableUBO.callcode;
            } else {
                available = false;
                availableText = 'Boken er ikke tilgjengelig.';
            }
            this.model.set('available', available);
            this.model.set('availableText', availableText);

            // Create template function
            template = _.template($('#bookFullTemplate').html());
            // Give data to template function and produce html
            html = template(this.model.toJSON());
            // Insert produced html into the view element
            this.$el.html(html);
            // Give the element an id
            this.$el.attr('id', 'bookFull'+this.model.get('id'));
            // Give each emneord element a data-url and a data-emneord attribute
            _.each(this.$('.emneord'), function(el, i, li) {
                var $listItem = $(el);
                // Give data-emneord
                $listItem.attr('data-emneord', $listItem.text());
                // Give data-url
                $listItem.attr('data-url', 'cat/'+$listItem.text());
            });
            this.$el.attr('data-url', this.model.get('id'));
        }

        return this;
    },
    events: {
        'click .emneord': 'onEmneOrdClick'
    },
    // This is for when a new emneord has been selected
    onEmneOrdClick: function(e) {
        var $li = $(e.target);
        // Change URL and trigger route handler
        router.navigate($li.attr('data-url'), {
            trigger: true,
            emneord: $li.attr('data-emneord')
        });
    }
});

// ---------------------------------------- DEFINE ROUTER

var AppRouter = Backbone.Router.extend({
    initialize: function(options) {
        // Store reference to book collection
        this.books = options.books;

        // Add listener for the rotate-event
        var self = this;
        $("#books").on('listenForActiveItem', function (e, bookId) {
            // We gave the images ids like "b345". We just want the number:
            bookId = bookId.substr(1);
            // Get the bookModel with this bookId
            var book = books.findWhere({ id: Number(bookId) });
            // Update the model and render
            bookFullView.model = book;
            bookFullView.render();
            // Update url
            self.navigate('cat/' + books._emneord + '/' + bookId);
        });

        // Add listener for key left/right
        $("#books").on('keyLeft', function(e) {
        	router.spinCarouselLeft();
        });
        $("#books").on('keyRight', function(e) {
        	router.spinCarouselRight();
        });

        // Add listener for title change
        $("#books").on('domTitleChange', function(e, title) {
            $(document).attr('title', 'Boksamling 42: '+title);
            $('#pageTitle').text('Boksamling 42: '+title);
        });
    },
    routes: {
        'cat/:emneord': 'viewEmneord',
        'cat/:emneord/:bookId': 'viewBookById',
        '*other': 'defaultView'
    },
    defaultView: function() {
        this.viewEmneord('Forskning');
    },
    newCarousel: function(emneord, callback) {
        // fetch books
        $('.loader').toggle();
        books.fetch({
            data: {
                collection: 1,
                real: emneord,
                limit: 100,
                q: '_exists_:subjects.noubomn'
            },
            success: function() {
                // Hide the loading icon
                $('.loader').toggle();
                // Store emneord in booksView
                books._emneord = emneord;
                // Render booksView
                booksView.render();
                // Update DOM title
                $('#books').trigger('domTitleChange', emneord);
            },
            error: function(){
                console.log('error in fetch');
            }
        });
    },
    spinCarousel: function(bookId) {
        carouSeal.rotateTo('b'+bookId);
        this.navigate('cat/' + books._emneord + '/' + bookId);
    },
    spinCarouselLeft: function() {
    	var rotateTo;
    	var indexOfCurrentBook = this.books.indexOf(bookFullView.model);
    	if (indexOfCurrentBook === 0) {
    		// Back to the beginning
    		rotateTo = this.books.length - 1;
    	} else {
    		rotateTo = indexOfCurrentBook - 1;
    	}
    	var rotateToBookId = this.books.at(rotateTo).get('id');
    	this.spinCarousel(rotateToBookId);
    },
    spinCarouselRight: function() {
    	var rotateTo;
    	var indexOfCurrentBook = this.books.indexOf(bookFullView.model);
    	if (indexOfCurrentBook + 1 === this.books.length) {
    		// Back to the beginning
    		rotateTo = 0;
    	} else {
    		rotateTo = indexOfCurrentBook + 1;
    	}
    	var rotateToBookId = this.books.at(rotateTo).get('id');
    	this.spinCarousel(rotateToBookId);
    },
    viewEmneord: function(emneord) {
        var self = this;
        // Load carousel IF new emneord
        if (books._emneord !== emneord) {
        	this.newCarousel(emneord);
        	// When that's done:
        	$("#books").one('carouselDone', function() {
        	    // Render bookFullView
        	    bookFullView.model = books.at(0);
        	    bookFullView.render();
        	    // Replace url
        	    self.navigate('cat/' + books._emneord + '/' + bookFullView.model.get('id'), {
        	        replace: true
        	    });
        	});
        } else {
        	// Else we just spin to the first book in the collection
        	this.spinCarousel(this.books.at(0).get('id'));
        }
    },
    viewBookById: function(emneord,bookId) {
        var self = this;
        // new carousel IF new emneord
        if (books._emneord !== emneord) {
            // Create the carousel
            this.newCarousel(emneord);
            // Spin when it's done
            $("#books").one('carouselDone', function() {
                self.spinCarousel(bookId);
                // Render bookFullView
                bookFullView.model = books.findWhere({ id: Number(bookId) });
                bookFullView.render();
            });
        } else {
            // Else just spin to position at once
            this.spinCarousel(bookId);
        }
    }
});

// ---------------------------------------- LISTEN TO KEY LEFT/RIGHT

$(document).keyup(function(e) {
	switch(e.which) {
		case 37: // left
			$('#books').trigger('keyLeft');
		break;

		case 39: // right
			$('#books').trigger('keyRight');
		break;
	}
	e.preventDefault();
});

// ---------------------------------------- CREATE COLLECTION

var books = new Books();

// ---------------------------------------- CREATE HELP MODAL

var Modal = Backbone.Modal.extend({
    template: '#helpModal',
    cancelEl: '.bbm-button'
});
$('#helpIcon').on('click', function() {
    var modalView = new Modal();
    $('#help').html(modalView.render().el);
});

// ---------------------------------------- CREATE VIEWS + ROUTER INSTANCE

var booksView = new BooksView({
    model: books
});

var bookFullView = new BookFullView();

// Create an instance of the router
var router = new AppRouter({
    books: books
});

// Tell backbone to start listening
Backbone.history.start();

})();

</script>

</body>
</html>
