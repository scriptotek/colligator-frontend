<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Backbone</title>
    <style>
    .loader{
        margin: 0 0 2em;
        height: 100px;
        width: 20%;
        text-align: center;
        padding: 1em;
        margin: 0 auto 1em;
        display: inline-block;
        vertical-align: top;
        display: none;
    }
    #books{
        height: 350px;
    }
    </style>
    <link rel="stylesheet" href="carouseal.css">
</head>
<body>

<div class="loader" title="0">
    <svg version="1.1" id="loader-1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
    width="40px" height="40px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">
    <path opacity="0.2" fill="#000" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946
    s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634
    c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z"/>
    <path fill="#000" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0
    C22.32,8.481,24.301,9.057,26.013,10.047z">
        <animateTransform
            attributeType="xml"
            attributeName="transform"
            type="rotate"
            from="0 20 20"
            to="360 20 20"
            dur="0.5s"
            repeatCount="indefinite"/>
    </path>
    </svg>
</div>
<div id="books"></div>
<div id="bookFull"></div>

<script src="bower_components/jquery/dist/jquery.js"></script>
<script src="bower_components/underscore/underscore.js"></script>
<script src="bower_components/backbone/backbone.js"></script>
<script src="bower_components/hammerjs/hammer.js"></script>
<script src="carouseal.js"></script>

<script id="bookListTemplate" type="text/template">
<img src="<%= cover %>" data-url="<%= id %>" id="b<%= id %>" alt="">
</script>

<script id="bookFullTemplate" type="text/template">
    <hr>
    <h2><%= title %></h2>
    <small><%= authors %> (<%= publisher %>)</small>
    <p><img src="<%= cover %>" alt=""></p>
    <p><%= description %></p>
    <p><strong>Emneord:</strong></p>
    <ul>
        <% _.each(subjects.noubomn, function(noubomnSubject) { %>
            <li class="emneord"><%= noubomnSubject.prefLabel %></li>
        <% }); %>
    </ul>
</script>

<script type="text/javascript">
(function() {

// ---------------------------------------- DEFINE MODEL + COLLECTION

var Book = Backbone.Model.extend({
    defaults: {
        title: '',
        isbn: '',
        authors: '',
        publisher: '',
        cover: 'http://snyderstreasures.com/images/thumbnails/germanmilitaria/books/BookReichsblattPlainC_small.jpg',
        description: 'Lorem ipsum dolor sit amet, consectetur adipisicing elit. Expedita rem explicabo nihil, harum sint sunt aliquam, nemo iste impedit eos voluptatum sed. Excepturi eaque quod ullam culpa praesentium beatae distinctio, voluptatem, illum accusamus cum corporis, at perferendis amet? Voluptatem iste, architecto ut.'
    }
});

var Books = Backbone.Collection.extend({
    model: Book,
    url: 'http://colligator.biblionaut.net/api/documents',
    parse: function(response, options) {

        // In the Book model above we've set a default image for the cover. The API gives cover: null if it didn't find a cover. Backbone will replace our own placeholder if the API returns any value at all (including null) for the cover property. Hence, we delete the cover property if the value is null, so that our placeholder cover is kept.
        var data = _.map(response.documents, function(val, ind, all) {
            if (val.cover===null) {
                delete val.cover;
            }
            return val;
        });

        return data;
    }
});

// ---------------------------------------- DEFINE VIEWS

var BookView = Backbone.View.extend({
    tagName: 'li',
    className: 'book',
    render: function() {

        // Create template function
        template = _.template($('#bookListTemplate').html());
        // Give data to template function and produce html
        html = template(this.model.toJSON());
        // Insert produced html into the view element
        this.$el.append(html);

        return this;
    }
});

var BooksView = Backbone.View.extend({
    el: '#books',
    className: 'books',
    render: function() {

        // Remove old views
        this.removeOldViews();
        // Empty content in case carouseal left something
        this.$el.empty();

        // Create new views
        var self = this;
        this.model.each(function(book) {
            var bookView = new BookView({ model: book });
            self._views.push(bookView);
            self.$el.append(bookView.render().$el);
        });
        // Now that we have the images in the div, convert them to a carousel
        this.convertToCarousel();
        return this;
    },
    initialize: function(options) {
        // Store reference to subviews created in render(), as we need to remove them when rerendering
        this._views = [];
        // Store reference to the event aggregator
        this.eventAggregator = options.eventAggregator;
        // Helper variable for the carousel
        this._carouselCreated = false;
    },
    removeOldViews: function() {
        _.each(this._views, function(view) {
            view.remove();
            view.unbind();
        });
    },
    convertToCarousel: function() {
        // Convert to carouseal
        // $("#books").carouSeal();
        carouSeal.element = $("#books");
        carouSeal.createCarousel();

        // Set crouselCreated to true
        this._carouselCreated = true;
        
        // Add listener for the rotate-event
        var self = this;
        $("#books").on('listenForActivecover', function (e, bookId) {
            // We gave the images ids like "b345". We just want the number:
            bookId = bookId.substr(1);
            // Get the bookModel with this bookId
            var book = books.findWhere({ id: Number(bookId) });
            // Trigger newBookSelected event to update the selected book
            self.eventAggregator.trigger('newBookSelected', book);
        });
    }
});

var BookFullView = Backbone.View.extend({
    el: '#bookFull',
    render: function() {

        var template; // Will hold the compiled template
        var html; // Will hold the result of template(data)

        // Only show information about a book if we have one
        if (this.model) {
            // Create a print-friendly attribute for the author names
            var authors = '';
            _.each(this.model.get('creators'), function(creator) {
                authors = authors.concat(', '+creator.name);
            });
            authors = authors.concat('.');
            authors = authors.substr(2); // Remove starting ', '
            // Store in model
            this.model.set('authors', authors);

            // Create template function
            template = _.template($('#bookFullTemplate').html());
            // Give data to template function and produce html
            html = template(this.model.toJSON());
            // Insert produced html into the view element
            this.$el.html(html);
            // Give the element an id
            this.$el.attr('id', 'bookFull'+this.model.get('id'));
            // Give each emneord element a data-url and a data-emneord attribute
            _.each(this.$('li.emneord'), function(el, i, li) {
                var $listItem = $(el);
                // Give data-emneord
                $listItem.attr('data-emneord', $listItem.text());
                // Give data-url
                $listItem.attr('data-url', 'searchEmneord/'+$listItem.text());
            });
            this.$el.attr('data-url', this.model.get('id'));
        }

        return this;
    },
    initialize: function(options) {
        // Store reference to global event bus
        this.eventAggregator = options.eventAggregator;
        // Listen to the newBookSelected event
        this.eventAggregator.on('newBookSelected', this.onNewBookSelected, this);
    },
    onNewBookSelected: function(book) {
        // The carousel has been rotated. Updating bookFullView..

        // Update the model and render
        this.model = book;
        this.render();
        // Change URL and trigger route handler
        // We need to figure out where we are, that is what the url looks like
        var fragmentArray = Backbone.history.getFragment().split('/');
        router.navigate(fragmentArray[0]+'/'+fragmentArray[1]+'/'+book.get('id'), {
            trigger: true
        });
    },
    events: {
        'click .emneord': 'onEmneOrdClick'
    },
    onEmneOrdClick: function(e) {
        var $li = $(e.target);
        // Change URL and trigger route handler
        router.navigate($li.attr('data-url'), {
            trigger: true,
            emneord: $li.attr('data-emneord')
        });
    }
});

// ---------------------------------------- DEFINE ROUTER

var AppRouter = Backbone.Router.extend({
    routes: {
        'searchEmneord/:emneord': 'carouselView',
        'searchEmneord/:emneord/:bookId': 'viewBookById',
        '*other': 'defaultView'
    },
    defaultView: function() {
        this.fetchAndRenderBooks('Forskning');
    },
    viewBookById: function(emneord,bookId) {
        // Does the carousel already exist?
        if (booksView._carouselCreated) {
            console.log('carousel exists already');
            console.log('spin to id: '+bookId);
            carouSeal.rotateTo('b'+bookId);
        } else {
            console.log('carousel must be created with emneord: '+emneord);
            console.log('then spin to id: '+bookId);
            this.fetchAndRenderBooks(emneord);
            carouSeal.rotateTo('b'+bookId);
        }
    },
    carouselView: function(emneord) {
        // Create carousel if it doesn't exist or if we have a new emneord
        if (!booksView._carouselCreated || booksView._emneord!==emneord) {
            this.fetchAndRenderBooks(emneord);
        } else {
            // Otherwise we just spin to position
            $("#books").carouSeal('b'+books.at(0).get('id'));
        }
    },
    initialize: function(options) {
        // Store reference to global event bus
        this.eventAggregator = options.eventAggregator;
        // Store reference to book collection
        this.books = options.books;
    },
    fetchAndRenderBooks: function(emneord) {
        $('.loader').toggle();
        books.fetch({
            data: {
                collection: 1,
                real: emneord,
                limit: 100,
                q: '_exists_:subjects.noubomn'
            },
            success: function() {
                // Hide the loading icon
                $('.loader').toggle();
                // Do we have any books?
                if (books.length>0) {
                    // Set the first book to bookFullView
                    bookFullView.model = books.at(0);
                    // Render views
                    bookFullView.render();
                    booksView.render();

                    // Store emneord in booksView
                    booksView._emneord = emneord;

                    router.navigate('searchEmneord/' + emneord + '/'+bookFullView.model.get('id'), {
                        trigger: false
                    });
                }else{
                    // Show error message if no books are found
                    $('#books').html('<p>No books found..</p>');
                }
            },
            error: function(){
                console.log('error in fetch');
            }
        });
    }
});

// ---------------------------------------- CREATE EVENT AGGREGATOR

var eventAggregator = _.extend({}, Backbone.Events);

// ---------------------------------------- CREATE COLLECTION

var books = new Books();

// ---------------------------------------- CREATE VIEWS + ROUTER INSTANCE

var booksView = new BooksView({
    model: books,
    eventAggregator: eventAggregator
});

var bookFullView = new BookFullView({
    eventAggregator: eventAggregator
});

// Create an instance of the router
var router = new AppRouter({
    eventAggregator: eventAggregator,
    books: books
});

// Tell backbone to start listening
Backbone.history.start();

})();

</script>

</body>
</html>
